{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center">
    <h1>{{ track.title }}</h1>
    <div>
        {% if current_user == track.creator or current_user.is_admin %}
        <a href="{{ url_for('main.edit_track', track_id=track.id) }}" class="btn btn-secondary btn-sm">编辑介绍</a>
        <form action="{{ url_for('main.delete_track', track_id=track.id) }}" method="post" style="display: inline;" onsubmit="return confirm('确定要删除整个曲目及其所有乐谱吗？');">
            <button type="submit" class="btn btn-danger btn-sm">删除曲目</button>
        </form>
        {% endif %}
    </div>
</div>
<p class="text-muted">由 {{ track.creator.username }} 创建于 {{ track.timestamp.strftime('%Y-%m-%d') }}</p>

<div class="card my-4">
    <div class="card-header">
        曲目介绍
    </div>
    <div class="card-body">
        {{ track.description | markdown | safe }}
    </div>
</div>

<hr>

<h3>乐谱文件</h3>

<div class="card my-4">
    <div class="card-body">
        <h5 class="card-title">上传新乐谱</h5>
        <form method="post" action="{{ url_for('main.upload_score', track_id=track.id) }}" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="description" class="form-label">文件描述 (例如: 四部混声总谱, 女高音声部谱)</label>
                <input type="text" class="form-control" id="description" name="description" required>
            </div>
            <div class="mb-3">
                <label for="file" class="form-label">选择 PDF 文件</label>
                <input class="form-control" type="file" id="file" name="file" accept=".pdf" required>
            </div>
            <button type="submit" class="btn btn-primary">上传</button>
        </form>
    </div>
</div>

<h4>已有乐谱</h4>
<ul class="list-group">
    {% for score in track.scores %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
            <strong>{{ score.description }}</strong>
            <br>
            <small class="text-muted">由 {{ score.uploader.username }} 上传于 {{ score.timestamp.strftime('%Y-%m-%d') }}</small>
        </div>
        <div>
            <button class="btn btn-info btn-sm" onclick="previewPdf('{{ url_for('main.uploaded_file', filename=score.filename) }}')">预览</button>
            <a href="{{ url_for('main.uploaded_file', filename=score.filename) }}" class="btn btn-success btn-sm" download>下载</a>
            {% if current_user == score.uploader or current_user.is_admin %}
            <form action="{{ url_for('main.delete_score', score_id=score.id) }}" method="post" style="display: inline;" onsubmit="return confirm('确定要删除这个乐谱文件吗？');">
                <button type="submit" class="btn btn-danger btn-sm">删除</button>
            </form>
            {% endif %}
        </div>
    </li>
    {% else %}
    <li class="list-group-item">该曲目下还没有乐谱。</li>
    {% endfor %}
</ul>

<div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pdfPreviewModalLabel">乐谱预览</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: 80vh;">
                <canvas id="pdf-canvas" style="width: 100%; height: 100%;"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/pdf.min.js') }}"></script>
<script>
    var pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = "{{ url_for('static', filename='js/pdf.worker.min.js') }}";
    var myModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'), {});

    function previewPdf(pdfUrl) {
        myModal.show();
        var canvas = document.getElementById('pdf-canvas');
        var context = canvas.getContext('2d');
        
        pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
            // 只显示第一页作为预览
            return pdf.getPage(1);
        }).then(function(page) {
            var viewport = page.getViewport({ scale: 1.5 });
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            var renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            page.render(renderContext);
        });
    }
</script>
{% endblock %}