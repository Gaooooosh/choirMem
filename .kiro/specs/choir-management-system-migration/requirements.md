# 北京邮电大学爱乐合唱团管理系统迁移需求文档

## 简介

本文档定义了从基于 Flask 的合唱团管理系统向 Next.js + Payload CMS 现代技术栈迁移的完整需求。文档基于旧项目的实际实现细节，明确标注了当前项目的实现状态，重点描述需要修复和完善的功能。

**标注说明：**
- ✅ **已实现** - 当前项目已正确实现
- ⚠️ **部分实现** - 已实现但有缺陷或不完整
- ❌ **未实现** - 完全缺失，需要新增
- 🔧 **需重构** - 实现方式有问题，需要重新设计

## 需求

### 需求 1: 用户认证与权限管理系统

**用户故事：** 作为系统管理员，我需要一个完整的用户认证和权限管理系统，以便控制不同用户对系统功能的访问权限。

#### 验收标准

**1.1 用户模型和认证** ⚠️ **部分实现**
1. WHEN 用户注册时 THEN 系统 SHALL 要求输入有效的邀请码
2. WHEN 用户注册时 THEN 系统 SHALL 验证邀请码有效性且有剩余使用次数
3. WHEN 用户注册时 THEN 系统 SHALL 根据邀请码预定义的权限组自动分配用户权限
4. WHEN 用户注册时 THEN 系统 SHALL 自动分配随机默认头像 ⚠️ **部分实现**
5. WHEN 用户注册时 THEN 系统 SHALL 减少邀请码剩余使用次数
6. WHEN 用户首次登录时 THEN 系统 SHALL 显示欢迎弹窗并标记已查看 ❌ **未实现**
7. WHEN 用户登录时 THEN 系统 SHALL 更新用户最后活动时间 ❌ **未实现**
8. WHEN 用户设置个人资料时 THEN 系统 SHALL 支持上传自定义头像和设置个人简介 ⚠️ **部分实现**

**1.2 权限组管理** ✅ **已实现**
1. WHEN 管理员创建权限组时 THEN 系统 SHALL 支持配置以下权限：
   - can_view_scores（查看乐谱）
   - can_upload_scores（上传乐谱）
   - can_upload_photos（上传照片）
   - can_post_comments（发表评论）
   - can_create_tracks（创建曲目）
   - can_manage_permission_groups（管理权限组）
   - can_manage_system_settings（管理系统设置）
   - can_manage_users（管理用户）
   - can_manage_invitation_codes（管理邀请码）

**1.3 用户活动统计** ❌ **未实现**
1. WHEN 用户上传乐谱时 THEN 系统 SHALL 增加 score_upload_count 计数
2. WHEN 用户上传照片时 THEN 系统 SHALL 增加 photo_upload_count 计数
3. WHEN 用户发表评论时 THEN 系统 SHALL 增加 comment_count 计数
4. WHEN 用户活动计数变化时 THEN 系统 SHALL 自动重新计算活动分数（评论×1分 + 乐谱×5分 + 照片×2分）

### 需求 2: 曲目和版本管理系统

**用户故事：** 作为合唱团成员，我需要一个完整的曲目和版本管理系统，能够按层级组织音乐作品，并支持中文排序。

#### 验收标准

**2.1 曲目（Track）管理** ⚠️ **部分实现**
1. WHEN 用户创建曲目时 THEN 系统 SHALL 自动生成中文拼音排序键 ❌ **未实现**
2. WHEN 系统显示曲目列表时 THEN 系统 SHALL 按中文拼音顺序正确排序 ❌ **未实现**
3. WHEN 用户搜索曲目时 THEN 系统 SHALL 支持模糊匹配标题内容 ⚠️ **部分实现**
4. WHEN 用户创建新曲目时 THEN 系统 SHALL 检查相似标题并提示用户 ❌ **未实现**

**2.2 版本（Version）管理** ✅ **已实现**
1. WHEN 用户为曲目创建版本时 THEN 系统 SHALL 记录创建者和创建时间
2. WHEN 用户查看版本时 THEN 系统 SHALL 显示相关的乐谱、照片和评论
3. WHEN 用户删除版本时 THEN 系统 SHALL 同时删除相关的文件资源

**2.3 版本评分系统** 🔧 **需重构**
1. WHEN 用户对版本评分时 THEN 系统 SHALL 防止同一用户重复评分 ❌ **未实现**
2. WHEN 用户提交评分时 THEN 系统 SHALL 验证分数范围（1-5分）
3. WHEN 版本有新评分时 THEN 系统 SHALL 自动计算平均难度 ❌ **未实现**
4. IF 用户已对版本评分 THEN 系统 SHALL 显示用户当前评分并允许修改

### 需求 3: 文件上传和访问控制

**用户故事：** 作为合唱团成员，我需要上传和访问乐谱及照片，系统应该根据我的权限控制访问。

#### 验收标准

**3.1 乐谱上传和管理** ⚠️ **部分实现**
1. WHEN 有权限用户上传乐谱时 THEN 系统 SHALL 只接受 PDF 格式文件
2. WHEN 用户访问乐谱时 THEN 系统 SHALL 验证用户具有 can_view_scores 权限 🔧 **需重构**
3. WHEN 用户下载乐谱时 THEN 系统 SHALL 生成包含曲目、版本、上传者信息的文件名 ❌ **未实现**
4. WHEN 用户预览乐谱时 THEN 系统 SHALL 在浏览器中内联显示 PDF ❌ **未实现**

**3.2 照片上传和管理** ⚠️ **部分实现**
1. WHEN 有权限用户上传照片时 THEN 系统 SHALL 支持常见图片格式（JPG、PNG、GIF、WebP）
2. WHEN 照片上传时 THEN 系统 SHALL 自动生成多种尺寸的缩略图 ✅ **已实现**
3. WHEN 用户查看照片时 THEN 系统 SHALL 显示上传者和上传时间信息

### 需求 4: 评论和互动系统

**用户故事：** 作为合唱团成员，我需要在曲目和版本下发表评论，与其他成员交流。

#### 验收标准

**4.1 评论管理** ✅ **已实现**
1. WHEN 用户发表评论时 THEN 系统 SHALL 验证评论必须关联到曲目或版本（但不能同时关联两者）
2. WHEN 用户发表评论时 THEN 系统 SHALL 记录评论时间和作者信息
3. WHEN 用户删除评论时 THEN 系统 SHALL 验证用户为评论作者或管理员

**4.2 点赞功能** ❌ **未实现**
1. WHEN 用户点赞版本时 THEN 系统 SHALL 记录点赞关系
2. WHEN 用户重复点赞时 THEN 系统 SHALL 取消点赞状态
3. WHEN 显示版本时 THEN 系统 SHALL 显示点赞数量和用户点赞状态

### 需求 5: 乐集管理系统

**用户故事：** 作为合唱团成员，我需要创建个人乐集来组织我喜欢的版本。

#### 验收标准

**5.1 乐集创建和管理** ✅ **已实现**
1. WHEN 用户创建乐集时 THEN 系统 SHALL 自动生成 URL 友好的 slug
2. WHEN 用户编辑乐集时 THEN 系统 SHALL 验证用户为创建者或管理员
3. WHEN 用户删除乐集时 THEN 系统 SHALL 保留其中的版本（仅删除关联关系）

**5.2 版本收藏** ✅ **已实现**
1. WHEN 用户将版本添加到乐集时 THEN 系统 SHALL 防止重复添加
2. WHEN 用户从乐集移除版本时 THEN 系统 SHALL 验证用户权限

### 需求 6: 文章系统

**用户故事：** 作为合唱团成员，我需要发表署名文章来分享经验和见解。

#### 验收标准

**6.1 文章创建和管理** ✅ **已实现**
1. WHEN 用户创建文章时 THEN 系统 SHALL 支持富文本编辑
2. WHEN 用户发布文章时 THEN 系统 SHALL 支持草稿和发布状态切换
3. WHEN 用户编辑文章时 THEN 系统 SHALL 验证用户为作者或管理员

### 需求 7: 系统管理功能

**用户故事：** 作为系统管理员，我需要完整的系统管理功能来维护平台运行。

#### 验收标准

**7.1 系统设置** ✅ **已实现**
1. WHEN 管理员配置系统时 THEN 系统 SHALL 支持控制用户注册开关
2. WHEN 管理员配置系统时 THEN 系统 SHALL 支持设置首页展示照片数量
3. WHEN 管理员配置系统时 THEN 系统 SHALL 支持配置 AI 文本润色提示词

**7.2 公告管理** ❌ **未实现**
1. WHEN 管理员创建公告时 THEN 系统 SHALL 支持不同级别的公告样式（success、warning、info 等）
2. WHEN 管理员激活公告时 THEN 系统 SHALL 自动停用其他公告（确保只有一个活跃公告）
3. WHEN 用户访问首页时 THEN 系统 SHALL 显示当前活跃的公告

**7.3 邀请码管理** ✅ **已实现**
1. WHEN 管理员生成邀请码时 THEN 系统 SHALL 要求选择目标权限组
2. WHEN 管理员生成邀请码时 THEN 系统 SHALL 支持设置使用次数限制（默认为10次）
3. WHEN 管理员生成邀请码时 THEN 系统 SHALL 自动生成唯一的32位十六进制邀请码
4. WHEN 用户使用邀请码注册时 THEN 系统 SHALL 验证邀请码有效且有剩余使用次数
5. WHEN 用户使用邀请码注册时 THEN 系统 SHALL 自动将新用户分配到邀请码预定义的权限组
6. WHEN 用户使用邀请码注册时 THEN 系统 SHALL 自动递减邀请码的剩余使用次数
7. WHEN 邀请码用尽时 THEN 系统 SHALL 自动标记为不可用
8. WHEN 管理员查看邀请码列表时 THEN 系统 SHALL 显示邀请码、关联权限组、剩余使用次数和创建时间
9. WHEN 管理员删除邀请码时 THEN 系统 SHALL 永久删除邀请码记录

### 需求 8: API 和数据服务

**用户故事：** 作为前端开发者，我需要完整的 API 支持来构建动态用户界面。

#### 验收标准

**8.1 成员列表 API** ❌ **未实现**
1. WHEN 前端请求成员列表时 THEN 系统 SHALL 按以下优先级排序：管理员优先 → 活动分数高优先 → 最近活跃优先
2. WHEN 前端请求成员列表时 THEN 系统 SHALL 支持分页加载
3. WHEN 显示成员信息时 THEN 系统 SHALL 包含头像、用户名、活动分数、最后活跃时间

**8.2 最新评论 API** ❌ **未实现**
1. WHEN 前端请求最新评论时 THEN 系统 SHALL 返回最近 20 条评论
2. WHEN 返回评论数据时 THEN 系统 SHALL 包含评论内容、作者信息、关联的曲目/版本信息
3. WHEN 返回评论数据时 THEN 系统 SHALL 生成正确的跳转链接

**8.3 AI 文本润色 API** ❌ **未实现**
1. WHEN 用户请求润色文本时 THEN 系统 SHALL 调用阿里云 DashScope API
2. WHEN API 调用失败时 THEN 系统 SHALL 返回友好的错误信息
3. WHEN 润色成功时 THEN 系统 SHALL 返回处理后的文本内容

### 需求 9: 首页和导航系统

**用户故事：** 作为用户，我需要一个直观的首页来浏览最新内容和进行快速导航。

#### 验收标准

**9.1 首页内容展示** ⚠️ **部分实现**
1. WHEN 用户访问首页时 THEN 系统 SHALL 展示曲目列表按中文拼音排序 ❌ **未实现**
2. WHEN 用户访问首页时 THEN 系统 SHALL 混合展示随机选择的照片 ❌ **未实现**
3. WHEN 用户在首页搜索时 THEN 系统 SHALL 支持曲目标题模糊匹配 ⚠️ **部分实现**
4. WHEN 显示活跃公告时 THEN 系统 SHALL 在页面顶部显示公告内容 ❌ **未实现**

**9.2 无限滚动加载** ❌ **未实现**
1. WHEN 用户滚动到页面底部时 THEN 系统 SHALL 自动加载更多内容
2. WHEN 加载更多内容时 THEN 系统 SHALL 保持搜索条件和排序方式
3. WHEN 没有更多内容时 THEN 系统 SHALL 显示适当的提示信息

### 需求 10: 数据迁移和兼容性

**用户故事：** 作为系统维护者，我需要将旧系统的数据完整迁移到新系统中。

#### 验收标准

**10.1 数据模型兼容** 🔧 **需重构**
1. WHEN 迁移用户数据时 THEN 系统 SHALL 保持所有用户统计字段的准确性
2. WHEN 迁移评分数据时 THEN 系统 SHALL 创建独立的 Rating 记录而非嵌套数组
3. WHEN 迁移曲目数据时 THEN 系统 SHALL 重新生成中文排序键
4. WHEN 迁移文件时 THEN 系统 SHALL 保持原有的访问路径兼容性

**10.2 权限映射** ✅ **已实现**
1. WHEN 迁移权限组时 THEN 系统 SHALL 映射所有原有权限到新的权限系统
2. WHEN 迁移用户时 THEN 系统 SHALL 保持用户与权限组的关联关系

### 需求 11: 性能和用户体验

**用户故事：** 作为用户，我需要系统响应迅速并提供良好的交互体验。

#### 验收标准

**11.1 文件处理优化** ⚠️ **部分实现**
1. WHEN 用户上传图片时 THEN 系统 SHALL 自动生成多种尺寸的缩略图以优化加载速度
2. WHEN 用户预览 PDF 时 THEN 系统 SHALL 优化加载策略减少等待时间
3. WHEN 系统处理大文件时 THEN 系统 SHALL 提供上传进度反馈

**11.2 缓存和优化** ❌ **未实现**
1. WHEN 用户频繁访问同一内容时 THEN 系统 SHALL 利用适当的缓存策略
2. WHEN 系统计算统计数据时 THEN 系统 SHALL 使用优化的查询避免性能问题
3. WHEN 用户操作触发计算时 THEN 系统 SHALL 异步处理避免阻塞用户界面

## 总结

当前项目在基础架构和核心数据模型方面已经建立了良好的基础，但在以下关键领域需要重点关注：

**最高优先级缺失功能：**
1. 独立的评分系统（Rating Collection）
2. 公告管理系统（Announcements Collection）
3. 用户活动统计和计分机制
4. 中文排序支持

**中等优先级缺失功能：**
1. 完整的 API 端点实现
2. 文件访问权限控制
3. 点赞功能
4. AI 文本润色集成

这些需求基于对原始 Flask 项目的深入分析，确保迁移后的系统能够保持所有原有功能并提供更好的用户体验。