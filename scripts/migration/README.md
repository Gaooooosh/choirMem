# 数据迁移脚本

这个目录包含了从旧系统迁移到新 Payload CMS 系统的完整迁移脚本。

## 文件结构

- `migrate.ts` - 主迁移脚本，协调整个迁移过程
- `old-data-reader.ts` - 读取旧数据库的数据
- `data-transformer.ts` - 将旧数据转换为新格式
- `file-migrator.ts` - 处理文件迁移（头像、乐谱、照片等）
- `id-mapper.ts` - 管理新旧 ID 之间的映射关系
- `utils.ts` - 通用工具函数

## 使用方法

### 1. 准备工作

确保你有：
- 旧系统的 SQLite 数据库文件
- 旧系统的文件目录（头像、乐谱、照片等）
- 新系统已经初始化并运行

### 2. 生成迁移报告

在执行迁移之前，建议先生成一个报告来了解迁移的规模：

```bash
pnpm migration:report
```

### 3. 执行迁移

```bash
pnpm migration migrate
```

迁移将按以下顺序进行：
1. 权限组（无依赖）
2. 用户（依赖权限组）
3. 标签（无依赖）
4. 曲目（依赖用户）
5. 曲目版本（依赖曲目、用户、标签）
6. 乐谱（依赖曲目版本、用户）
7. 照片/媒体（依赖用户）
8. 评论（依赖用户、曲目、曲目版本）
9. 文章（依赖用户）
10. 邀请码（依赖权限组）
11. 系统设置（无依赖）

### 4. 回滚（紧急情况）

如果迁移出现问题，可以回滚：

```bash
pnpm migration:rollback
```

**警告：回滚将删除所有迁移的数据，请谨慎使用！**

## 配置

迁移脚本使用以下默认路径：
- 旧数据库：`./old-database.db`
- 旧文件目录：`./old-files`
- 新文件目录：`./uploads`

如需修改这些路径，请编辑 `migrate.ts` 文件中的构造函数参数。

## 输出文件

迁移完成后，会生成以下文件：
- `id-mappings.json` - 新旧 ID 映射关系，用于调试和验证

## 注意事项

1. **备份**：在执行迁移之前，请务必备份你的数据
2. **环境**：建议在测试环境中先执行迁移
3. **依赖**：确保 Payload CMS 已正确配置并能正常运行
4. **权限**：确保脚本有读写文件和数据库的权限
5. **内存**：大量数据迁移可能需要较多内存，建议在服务器环境中执行

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查数据库文件路径是否正确
   - 确保有读取权限

2. **文件迁移失败**
   - 检查文件路径是否正确
   - 确保有读写权限
   - 检查磁盘空间是否充足

3. **类型错误**
   - 检查 Payload 配置是否与迁移脚本匹配
   - 确保所有必需的集合都已定义

### 日志

迁移过程中的所有操作都会记录日志，包括：
- 进度信息
- 错误详情
- 统计数据

## 开发

如需修改迁移逻辑：

1. 修改相应的文件
2. 运行 TypeScript 检查：`npx tsc --noEmit scripts/migration/migrate.ts`
3. 在测试环境中验证修改

## 支持

如遇到问题，请检查：
1. 日志输出中的错误信息
2. `id-mappings.json` 文件中的映射关系
3. 数据库中的实际数据